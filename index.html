<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>CU Navigate ‚Äî Indoor 3D Map (Premium)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="https://unpkg.com/maplibre-gl@3.3.1/dist/maplibre-gl.css" rel="stylesheet" />

  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:"Inter",sans-serif;}
    html,body,#map{width:100%;height:100%;}

    /* TOP BAR */
    #top-bar{
      position:absolute;
      top:20px;
      left:50%;
      transform:translateX(-50%);
      width:60%;
      height:48px;
      z-index:2000;
      background:rgba(255,255,255,0.18);
      backdrop-filter:blur(12px);
      padding:8px 18px;
      border-radius:14px;
      display:flex;
      align-items:center;
      gap:10px;
      box-shadow:0 4px 18px rgba(0,0,0,0.15);
      border:1px solid rgba(255,255,255,0.35);
    }

    #logo{font-size:22px;font-weight:700;color:#0a3d62;white-space:nowrap;}
    #search-box{
      flex:1;height:35px;border-radius:10px;border:none;padding:0 15px;
      background:white;font-size:14px;outline:none;
    }
    .top-btn{
      background:#0a3d62;color:white;padding:6px 14px;border-radius:10px;
      border:none;font-size:13px;font-weight:600;cursor:pointer;
      transition:0.2s;
    }
    .top-btn:hover{background:#124b7a;}

    /* SEARCH RESULTS DROPDOWN */
    #search-results{
      position:absolute;
      top:70px;
      left:50%;
      transform:translateX(-50%);
      width:50%;
      max-height:220px;
      overflow-y:auto;
      background:white;
      z-index:2100;
      border-radius:10px;
      box-shadow:0 6px 18px rgba(0,0,0,0.2);
      display:none;
    }
    .search-item{
      padding:8px 12px;
      font-size:14px;
      cursor:pointer;
      border-bottom:1px solid #f1f1f1;
    }
    .search-item:hover{
      background:#f1f5f9;
    }

    /* SIDE PANEL */
    #side-panel{
      position:absolute;top:60px;left:20px;width:300px;
      background:rgba(255,255,255,0.22);backdrop-filter:blur(15px);
      padding:20px;border-radius:18px;z-index:2000;
      box-shadow:0 8px 30px rgba(0,0,0,0.2);
      border:1px solid rgba(255,255,255,0.35);
      animation:fadeSlide 0.4s ease;
    }
    @keyframes fadeSlide{
      from{opacity:0;transform:translateY(10px);} to{opacity:1;transform:translateY(0);}
    }
    .panel-title{
      font-size:17px;font-weight:700;color:#0a3d62;margin-bottom:10px;
    }
    .panel-subtitle{
      font-size:12px;color:#636e72;margin-bottom:15px;
    }
    .select-box{
      width:100%;padding:8px 12px;margin-bottom:10px;
      border-radius:10px;border:none;font-size:14px;background:white;outline:none;
    }
    .route-btn{
      width:100%;padding:10px 0;border-radius:12px;
      background:linear-gradient(135deg,#008cff,#0052cc);
      font-size:16px;font-weight:700;color:white;border:none;cursor:pointer;
      transition:0.2s;
    }
    .route-btn:hover{opacity:0.95;}
    .reset-btn{
      width:100%;padding:8px 0;margin-top:8px;border:none;border-radius:10px;
      background:#ee5253;color:white;cursor:pointer;transition:0.2s;
    }
    .reset-btn:hover{background:#d63031;}

    #route-info{
      margin-top:12px;
      font-size:13px;
      color:#2d3436;
      line-height:1.5;
      min-height:40px;
    }
    #directions-list{
      margin-top:8px;
      max-height:120px;
      overflow-y:auto;
      font-size:12px;
      color:#2d3436;
    }
    .direction-step{
      margin-bottom:4px;
    }

    /* FLOORS BAR */
    #floors-bar{
      position:absolute;right:20px;top:120px;width:60px;z-index:2000;
      background:rgba(255,255,255,0.18);backdrop-filter:blur(15px);
      border-radius:18px;padding:8px 0;text-align:center;
      box-shadow:0 6px 20px rgba(0,0,0,0.2);
      border:1px solid rgba(255,255,255,0.35);
    }
    .floor-btn{
      padding:10px 0;width:100%;cursor:pointer;font-weight:600;
      border-bottom:1px solid rgba(255,255,255,0.4);
      transition:0.2s;font-size:13px;
    }
    .floor-btn:last-child{border-bottom:none;}
    .floor-btn:hover{background:rgba(255,255,255,0.3);} 
    .floor-active{background:#0a3d62;color:white;}

    /* MAP CONTROLS */
    .map-controls{
      position:absolute;bottom:25px;right:25px;z-index:2000;
      display:flex;flex-direction:column;gap:10px;
    }
    .ctrl-btn{
      width:45px;height:45px;border-radius:12px;
      background:rgba(255,255,255,0.3);backdrop-filter:blur(10px);
      border:1px solid rgba(255,255,255,0.4);
      display:flex;align-items:center;justify-content:center;
      font-size:20px;cursor:pointer;transition:0.2s;
    }
    .ctrl-btn:hover{background:rgba(255,255,255,0.5);}  

    /* USER / SCHEDULE PANEL */
    #user-panel{
      position:absolute;
      top: 435px;
      left:20px;
      width:300px;
      background:rgba(255,255,255,0.22);
      backdrop-filter:blur(15px);
      padding:16px;
      border-radius:18px;
      z-index:2000;
      box-shadow:0 8px 30px rgba(0,0,0,0.2);
      border:1px solid rgba(255,255,255,0.35);
    }

    #user-panel-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      cursor:pointer;
      gap:8px;
    }
    .user-title{
      font-size:15px;font-weight:700;color:#0a3d62;margin-bottom:4px;
    }
    #user-toggle-arrow{
      font-size:14px;
      color:#0a3d62;
      transition:transform 0.2s;
    }
    #user-panel.collapsed #user-toggle-arrow{
      transform:rotate(-90deg);
    }
    #user-panel-body{
      margin-top:6px;
    }
    #user-panel.collapsed #user-panel-body{
      display:none;
    }

    .user-input{
      width:100%;margin-bottom:8px;padding:7px 10px;
      border-radius:10px;border:none;font-size:13px;background:white;outline:none;
    }
    .user-btn{
      width:100%;padding:8px 0;border-radius:10px;border:none;
      background:#0a3d62;color:white;font-size:13px;font-weight:600;cursor:pointer;margin-top:2px;
    }
    .user-btn:hover{background:#124b7a;}
    .user-btn-secondary{
      width:100%;padding:8px 0;margin-top:10px;border-radius:10px;border:none;
      background:#0984e3;color:white;font-size:13px;font-weight:600;cursor:pointer;
    }
    .user-btn-secondary:disabled{opacity:0.5;cursor:not-allowed;}
    .today-lecture-title{
      font-size:13px;font-weight:600;margin-top:8px;color:#2d3436;
    }
    .today-lecture-meta{
      font-size:12px;color:#636e72;margin-top:4px;
    }

    /* ADS PANEL */
    #ads-panel{
      position:absolute;left:20px;bottom:20px;width:300px;
      background:rgba(255,255,255,0.22);backdrop-filter:blur(15px);
      padding:12px 14px;border-radius:16px;z-index:2000;
      box-shadow:0 6px 24px rgba(0,0,0,0.2);
      border:1px solid rgba(255,255,255,0.35);
    }
    .ads-title{
      font-size:14px;font-weight:700;color:#0a3d62;margin-bottom:6px;
    }
    #ads-list{max-height:160px;overflow-y:auto;}
    .ad-card{
      padding:8px 10px;border-radius:10px;background:white;margin-bottom:6px;cursor:pointer;
      transition:0.2s;box-shadow:0 2px 8px rgba(0,0,0,0.08);
    }
    .ad-card:hover{
      transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.15);
    }
    .ad-title{
      font-size:13px;font-weight:600;color:#2d3436;margin-bottom:2px;
    }
    .ad-text{
      font-size:12px;color:#636e72;margin-bottom:4px;
    }
    .ad-badge{
      font-size:10px;font-weight:600;color:#e67e22;text-transform:uppercase;
    }

    /* LOGIN OVERLAY */
    #login-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.45);
      backdrop-filter:blur(14px);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:3000;
    }
    .login-card{
      width:360px;
      max-width:90%;
      background:rgba(255,255,255,0.96);
      border-radius:20px;
      padding:24px 22px;
      box-shadow:0 10px 35px rgba(0,0,0,0.25);
      text-align:center;
    }
    .login-title{
      font-size:18px;
      font-weight:700;
      color:#0a3d62;
      margin-bottom:6px;
    }
    .login-subtitle{
      font-size:12px;
      color:#636e72;
      margin-bottom:14px;
    }
    .login-input{
      width:100%;
      margin-bottom:8px;
      padding:8px 11px;
      border-radius:10px;
      border:none;
      font-size:13px;
      background:#fdfdfd;
      outline:none;
    }
    .login-btn{
      width:100%;
      padding:9px 0;
      border-radius:12px;
      border:none;
      background:linear-gradient(135deg,#008cff,#0052cc);
      color:#fff;
      font-size:14px;
      font-weight:700;
      cursor:pointer;
      margin-top:4px;
    }
    .login-btn:hover{opacity:0.95;}

    /* AI CHAT PANEL */
    #ai-panel{
      position:absolute;
      right:20px;
      bottom:80px;
      width:320px;
      max-height:260px;
      background:rgba(255,255,255,0.95);
      border-radius:16px;
      box-shadow:0 8px 24px rgba(0,0,0,0.25);
      border:1px solid rgba(15,23,42,0.12);
      padding:10px 12px;
      z-index:2500;
      display:none;
      flex-direction:column;
    }
    .ai-title{
      font-size:14px;
      font-weight:700;
      color:#0f172a;
      margin-bottom:4px;
    }
    .ai-subtitle{
      font-size:11px;
      color:#6b7280;
      margin-bottom:6px;
    }
    #ai-messages{
      flex:1;
      overflow-y:auto;
      font-size:12px;
      padding-right:4px;
      margin-bottom:6px;
    }
    .ai-msg{
      margin-bottom:4px;
      line-height:1.4;
    }
    .ai-msg-user{
      text-align:right;
      color:#111827;
    }
    .ai-msg-ai{
      text-align:left;
      color:#0f172a;
    }
    .ai-input-row{
      display:flex;
      gap:6px;
    }
    #ai-input{
      flex:1;
      border-radius:999px;
      border:1px solid #e5e7eb;
      padding:6px 10px;
      font-size:12px;
      outline:none;
    }
    #ai-input:focus{
      border-color:#0a3d62;
    }
    #ai-send-btn{
      border:none;
      border-radius:999px;
      padding:6px 12px;
      font-size:12px;
      font-weight:600;
      background:#0a3d62;
      color:#fff;
      cursor:pointer;
    }
    #ai-send-btn:hover{
      background:#124b7a;
    }

    /* Floating AI button */
    .ai-float-btn{
      position:absolute;
      right:20px;
      bottom:25px;
      width:52px;
      height:52px;
      border-radius:50%;
      border:none;
      background:#0a3d62;
      color:#fff;
      font-size:22px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      box-shadow:0 6px 20px rgba(0,0,0,0.25);
      z-index:2500;
    }
    .ai-float-btn:hover{
      background:#124b7a;
    }

    /* MOBILE TOGGLE BUTTONS */
    .mobile-toggle-btn{
      display:none;
      position:absolute;
      left:15px;
      width:auto;
      padding:10px 16px;
      background:linear-gradient(135deg,#0a3d62,#124b7a);
      color:#fff;
      border:none;
      border-radius:12px;
      font-size:13px;
      font-weight:600;
      cursor:pointer;
      z-index:2100;
      box-shadow:0 4px 15px rgba(0,0,0,0.2);
      transition:0.2s;
    }
    .mobile-toggle-btn:hover{
      opacity:0.9;
    }
    #nav-toggle-btn{
      top:80px;
    }
    #mayday-toggle-btn{
      top:130px;
      background:linear-gradient(135deg,#ee5253,#d63031);
    }

    /* MOBILE STYLES */
    @media (max-width: 768px) {
      /* Show mobile toggle buttons */
      .mobile-toggle-btn{
        display:flex;
        align-items:center;
        gap:6px;
      }

      /* Hide side panel by default on mobile */
      #side-panel{
        display:none;
        position:fixed;
        top:50%;
        left:50%;
        transform:translate(-50%,-50%);
        width:90%;
        max-width:320px;
        max-height:70vh;
        overflow-y:auto;
        z-index:2500;
      }
      #side-panel.mobile-open{
        display:block;
        animation:fadeSlide 0.3s ease;
      }

      /* Hide user panel by default on mobile */
      #user-panel{
        display:none;
        position:fixed;
        top:50%;
        left:50%;
        transform:translate(-50%,-50%);
        width:90%;
        max-width:320px;
        max-height:60vh;
        overflow-y:auto;
        z-index:2500;
      }
      #user-panel.mobile-open{
        display:block;
        animation:fadeSlide 0.3s ease;
      }

      /* Ads panel mobile - small strip on left */
      #ads-panel{
        position:fixed;
        left:10px;
        bottom:10px;
        width:140px;
        max-height:50vh;
        padding:10px;
        border-radius:12px;
      }
      #ads-panel .ads-title{
        font-size:12px;
        margin-bottom:4px;
      }
      #ads-list{
        max-height:calc(50vh - 40px);
        overflow-y:auto;
      }
      #ads-list .ad-card{
        padding:6px 8px;
        margin-bottom:4px;
      }
      #ads-list .ad-title{
        font-size:11px;
      }
      #ads-list .ad-text{
        font-size:10px;
        display:-webkit-box;
        -webkit-line-clamp:2;
        -webkit-box-orient:vertical;
        overflow:hidden;
      }
      #ads-list .ad-badge{
        font-size:9px;
      }

      /* Top bar mobile adjustments */
      #top-bar{
        width:92%;
        padding:6px 12px;
        height:44px;
      }
      #logo{
        font-size:16px;
      }
      #search-box{
        height:30px;
        font-size:12px;
      }
      .top-btn{
        padding:5px 10px;
        font-size:11px;
      }

      /* Search results mobile */
      #search-results{
        width:85%;
        top:65px;
      }

      /* Floors bar mobile */
      #floors-bar{
        right:10px;
        top:80px;
        width:45px;
      }
      .floor-btn{
        padding:8px 0;
        font-size:11px;
      }

      /* Map controls mobile */
      .map-controls{
        bottom:15px;
        right:10px;
      }
      .ctrl-btn{
        width:38px;
        height:38px;
        font-size:18px;
      }

      /* AI panel mobile */
      #ai-panel{
        right:10px;
        bottom:65px;
        width:280px;
        max-height:220px;
      }
      .ai-float-btn{
        right:10px;
        bottom:15px;
        width:45px;
        height:45px;
        font-size:18px;
      }

      /* Mobile overlay backdrop */
      .mobile-overlay{
        display:none;
        position:fixed;
        inset:0;
        background:rgba(0,0,0,0.4);
        z-index:2400;
      }
      .mobile-overlay.active{
        display:block;
      }
    }
  </style>
</head>

<body>

<!-- TOP BAR -->
<div id="top-bar">
  <div id="logo">CU Navigate</div>
  <input id="search-box" placeholder="Search for a room...">
  <button id="resetRouteBtn" class="top-btn">Reset</button>
</div>
<div id="search-results"></div>

<!-- SIDE PANEL -->
<div id="side-panel">
  <div class="panel-title">Navigation</div>
  <div class="panel-subtitle">Select start and destination rooms, then hit "Find Route"</div>
  <select id="fromRoomPanel" class="select-box"></select>
  <select id="toRoomPanel" class="select-box"></select>
  <button id="panelRouteBtn" class="route-btn">Find Route</button>
  <button id="panelResetBtn" class="reset-btn">Reset</button>
  <div id="route-info"></div>
  <div id="directions-list"></div>
</div>

<!-- LOGIN OVERLAY -->
<div id="login-overlay">
  <div class="login-card">
    <div class="login-title">Welcome to CU Navigate</div>
    <div class="login-subtitle">Sign in to see your schedule and live routes</div>
    <input id="login-name" class="login-input" placeholder="Your name">
    <select id="login-level" class="login-input">
      <option value="">Choose academic level</option>
      <option value="Level1">Level 1</option>
      <option value="Level2">Level 2</option>
      <option value="Level3">Level 3</option>
      <option value="Level4">Level 4</option>
    </select>
    <select id="login-group" class="login-input">
      <option value="">Choose group</option>
      <option value="G1">Group 1</option>
      <option value="G2">Group 2</option>
      <option value="G3">Group 3</option>
      <option value="G4">Group 4</option>
    </select>
    <button id="login-save" class="login-btn">Start navigation</button>
  </div>
</div>

<!-- STUDENT / SCHEDULE PANEL -->
<div id="user-panel">
  <div id="user-panel-header">
    <div class="user-title" id="user-title-text">My Day</div>
    <div id="user-toggle-arrow">‚ñæ</div>
  </div>
  <div id="user-panel-body">
    <div id="auth-section">
      <input id="student-name" class="user-input" placeholder="Your name">
      <select id="student-level" class="user-input">
        <option value="">Choose academic level</option>
        <option value="Level1">Level 1</option>
        <option value="Level2">Level 2</option>
        <option value="Level3">Level 3</option>
        <option value="Level4">Level 4</option>
      </select>
      <select id="student-group" class="user-input">
        <option value="">Choose group</option>
        <option value="G1">Group 1</option>
        <option value="G2">Group 2</option>
        <option value="G3">Group 3</option>
        <option value="G4">Group 4</option>
      </select>
      <button id="save-profile" class="user-btn">Save profile</button>
    </div>
    <div id="today-lecture-box">
      <div id="today-lecture-title" class="today-lecture-title">No profile yet</div>
      <div id="today-lecture-meta" class="today-lecture-meta"></div>
    </div>
    <button id="go-lecture-btn" class="user-btn-secondary" disabled>Go to first lecture</button>
  </div>
</div>

<!-- ADS PANEL -->
<div id="ads-panel">
  <div class="ads-title">Campus Ads</div>
  <div id="ads-list"></div>
</div>

<!-- AI CHAT PANEL -->
<div id="ai-panel">
  <div class="ai-title">CU Navigate AI</div>
  <div class="ai-subtitle">ÿßÿ≥ÿ£ŸÑ ÿπŸÜ ÿ¨ÿØŸàŸÑŸÉ ÿ£Ÿà ÿ£Ÿä ÿ≥ÿ§ÿßŸÑ ÿ™ÿßŸÜŸä Ÿäÿß ŸÜÿ¨ŸÖ ‚ú®</div>
  <div id="ai-messages"></div>
  <div class="ai-input-row">
    <input id="ai-input" placeholder="ÿßÿ≥ÿ£ŸÑ ÿπŸÜ ŸÖÿ≠ÿßÿ∂ÿ±ÿ© ÿ£Ÿà ÿ£Ÿä ÿ≠ÿßÿ¨ÿ©...">
    <button id="ai-send-btn">Send</button>
  </div>
</div>

<!-- Floating AI button -->
<button id="ai-toggle-btn" class="ai-float-btn">üí¨</button>

<!-- FLOORS BAR -->
<div id="floors-bar"></div>

<!-- MOBILE TOGGLE BUTTONS -->
<button id="nav-toggle-btn" class="mobile-toggle-btn">üìç Navigation</button>
<button id="mayday-toggle-btn" class="mobile-toggle-btn">üÜò Maydays</button>

<!-- MOBILE OVERLAY -->
<div id="mobile-overlay" class="mobile-overlay"></div>

<!-- CONTROLS -->
<div class="map-controls">
  <div class="ctrl-btn" id="zoomIn">+</div>
  <div class="ctrl-btn" id="zoomOut">‚àí</div>
  <div class="ctrl-btn" id="tiltBtn">‚§¢</div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/maplibre-gl@3.3.1/dist/maplibre-gl.js"></script>
<script>
// ===== Demo schedule (ŸÉŸÖÿß ŸáŸà) =====
const scheduleData = {
  G1: [
    { day:'Sun', time:'09:00', subject:'Operating Systems', hall:'HALL559' },
    { day:'Sun', time:'11:00', subject:'Computer Networks', hall:'HALL561' },
    { day:'Mon', time:'10:00', subject:'Image Processing', hall:'HALL262' },
    { day:'Tue', time:'09:00', subject:'Embedded Systems', hall:'HALL563' },
    { day:'Wed', time:'11:00', subject:'Graduation Project', hall:'HALL659' }
  ],
  G2: [
    { day:'Sun', time:'09:00', subject:'Computer Networks', hall:'HALL561' },
    { day:'Sun', time:'11:00', subject:'Operating Systems', hall:'HALL559' },
    { day:'Mon', time:'09:00', subject:'Embedded Systems', hall:'HALL563' },
    { day:'Tue', time:'11:00', subject:'Image Processing', hall:'HALL262' },
    { day:'Wed', time:'10:00', subject:'Graduation Project', hall:'HALL659' }
  ],
  G3: [
    { day:'Sun', time:'10:00', subject:'Embedded Systems', hall:'HALL563' },
    { day:'Mon', time:'09:00', subject:'Operating Systems', hall:'HALL559' },
    { day:'Mon', time:'11:00', subject:'Computer Networks', hall:'HALL561' },
    { day:'Tue', time:'10:00', subject:'Digital Signal Processing', hall:'HALL262' },
    { day:'Wed', time:'09:00', subject:'Graduation Project', hall:'HALL659' }
  ],
  G4: [
    { day:'Sun', time:'09:00', subject:'Computer Graphics', hall:'HALL262' },
    { day:'Sun', time:'11:00', subject:'Operating Systems', hall:'HALL559' },
    { day:'Mon', time:'10:00', subject:'Computer Networks', hall:'HALL561' },
    { day:'Tue', time:'09:00', subject:'Embedded Systems', hall:'HALL563' },
    { day:'Wed', time:'11:00', subject:'Graduation Project', hall:'HALL659' }
  ]
};

const dayLabels = {
  Sun:'ÿßŸÑÿ£ÿ≠ÿØ',
  Mon:'ÿßŸÑÿßÿ´ŸÜŸäŸÜ',
  Tue:'ÿßŸÑÿ´ŸÑÿßÿ´ÿßÿ°',
  Wed:'ÿßŸÑÿ£ÿ±ÿ®ÿπÿßÿ°',
  Thu:'ÿßŸÑÿÆŸÖŸäÿ≥',
  Fri:'ÿßŸÑÿ¨ŸÖÿπÿ©',
  Sat:'ÿßŸÑÿ≥ÿ®ÿ™'
};

const map = new maplibregl.Map({
  container: 'map',
  style: 'https://api.maptiler.com/maps/basic/style.json?key=qInXeM6uWFkNwulx00w1',
  center: [31.20, 30.03],
  zoom: 18.5,
  pitch: 60,
  bearing: -20,
  antialias: true
});

async function loadGeoJSON(url){
  const res = await fetch(url);
  if(!res.ok) throw new Error('HTTP ERROR ' + res.status + ' for ' + url);
  return res.json();
}

function distance(a,b){
  return Math.sqrt((a[0]-b[0])**2 + (a[1]-b[1])**2);
}
function findNearestNode(point,nodes){
  let min=Infinity, nearest=null;
  for(const n of nodes){
    const d=distance(point,n);
    if(d<min){min=d;nearest=n;}
  }
  return nearest;
}
function buildGraph(features){
  const g=new Map();
  for(const f of features){
    const geom=f.geometry;
    if(!geom) continue;
    const lines = (geom.type==='MultiLineString'
      ? geom.coordinates
      : (geom.type==='LineString' ? [geom.coordinates] : []));
    for(const ln of lines){
      for(let i=0;i<ln.length-1;i++){
        const a=ln[i], b=ln[i+1];
        const ka=a.join(','), kb=b.join(',');
        if(!g.has(ka)) g.set(ka,[]);
        if(!g.has(kb)) g.set(kb,[]);
        const w=distance(a,b);
        g.get(ka).push({node:kb,weight:w});
        g.get(kb).push({node:ka,weight:w});
      }
    }
  }
  return g;
}
function addTransitions(g, features){
  for(const f of features){
    const geom=f.geometry;
    if(!geom) continue;
    const line = (geom.type==='LineString'
      ? geom.coordinates
      : (geom.type==='MultiLineString' ? geom.coordinates[0] : null));
    if(!line || line.length<2) continue;
    const a=line[0], b=line[line.length-1];
    const ka=a.join(','), kb=b.join(',');
    if(!g.has(ka)) g.set(ka,[]);
    if(!g.has(kb)) g.set(kb,[]);
    const w=f.properties && f.properties.LENGTH_3D
      ? f.properties.LENGTH_3D
      : distance(a,b);
    g.get(ka).push({node:kb,weight:w});
    g.get(kb).push({node:ka,weight:w});
  }
}
function dijkstra(graph,start,end){
  const dist={}, prev={}, q=new Set(graph.keys());
  for(const n of q) dist[n]=Infinity;
  dist[start]=0;
  while(q.size>0){
    const u=[...q].reduce((a,b)=>dist[a]<dist[b]?a:b);
    q.delete(u);
    if(u===end) break;
    const neighbors=graph.get(u) || [];
    for(const e of neighbors){
      const alt=dist[u]+e.weight;
      if(alt<dist[e.node]){
        dist[e.node]=alt;
        prev[e.node]=u;
      }
    }
  }
  if(dist[end]===Infinity) return [];
  const path=[]; let u=end;
  while(prev[u]){
    path.unshift(u.split(',').map(Number));
    u=prev[u];
  }
  path.unshift(start.split(',').map(Number));
  return path;
}

// *** NEW: ÿ™ÿ≠ŸàŸäŸÑ LEVEL_ID ÿ•ŸÑŸâ floorIndex (0,1,2,...) ***
function getFloorIndexFromLevelId(lvl){
  const m = String(lvl).match(/\d+/);
  return m ? parseInt(m[0],10) - 1 : 0;
}

// *** NEW: buildRouteExtrusion ÿ®ŸÜÿ≥ÿÆÿ© MazeMap (ÿ®ŸÑÿßÿ∑ÿßÿ™ 2D + isCurrentLevel) ***
function buildRouteExtrusion(path, currentFloorIndex) {
  const width = 0.000012;
  const features = [];

  for (let i = 0; i < path.length - 1; i++) {
    const p1 = path[i];
    const p2 = path[i + 1];

    const x1 = p1[0], y1 = p1[1], z1 = p1[2] || 0;
    const x2 = p2[0], y2 = p2[1], z2 = p2[2] || 0;

    const dx = x2 - x1;
    const dy = y2 - y1;
    const len = Math.sqrt(dx*dx + dy*dy);
    if (!len) continue;

    const ux = -dy / len;
    const uy =  dx / len;
    const half = width / 2;

    const l1 = [x1 + ux * half, y1 + uy * half];
    const r1 = [x1 - ux * half, y1 - uy * half];
    const l2 = [x2 + ux * half, y2 + uy * half];
    const r2 = [x2 - ux * half, y2 - uy * half];

    const floorIndex1 = Math.round(z1 / 5);
    const floorIndex2 = Math.round(z2 / 5);
    const floorIndex = Math.round((floorIndex1 + floorIndex2) / 2);

    features.push({
      type: 'Feature',
      properties: {
        floorIndex,
        isCurrentLevel: currentFloorIndex == null ? true : (floorIndex === currentFloorIndex)
      },
      geometry: {
        type: 'Polygon',
        coordinates: [[l1, l2, r2, r1, l1]]
      }
    });
  }

  return { type: 'FeatureCollection', features };
}



/* Animation vars */
let animatedMarker = null;
let animationFrameId = null;
// *** NEW: ŸÜÿÆÿ≤ŸÜ ÿ¢ÿÆÿ± ŸÖÿ≥ÿßÿ± ŸÖÿ±ÿ≥ŸàŸÖ ÿπÿ¥ÿßŸÜ ŸÜŸÑŸàŸëŸÜŸá ÿ≠ÿ≥ÿ® ÿßŸÑÿØŸàÿ± ***
let lastRoutePath = null;

// profile / schedule / ads
let studentProfile = null;
let currentSchedule = [];
let firstLecture = null;
let entranceRoomId = null;
let adsData = [];

map.on('load', async ()=>{
  let detailsData, pathwaysData, transitionsData, unitsData, levelsData;
  try {
    [
      detailsData,
      pathwaysData,
      transitionsData,
      unitsData,
      levelsData
    ] = await Promise.all([
      loadGeoJSON('Indoor_Detail.geojson'),
      loadGeoJSON('Indoor_Pathways.geojson'),
      loadGeoJSON('Indoor_Transitions.geojson'),
      loadGeoJSON('Indoor_Units.geojson'),
      loadGeoJSON('Indoor_Levels.geojson')
    ]);
  } catch (err) {
    console.error('Error loading indoor data:', err);
    alert('‚ùå ŸÅŸä ŸÖÿ¥ŸÉŸÑÿ© ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÄ GeoJSON. ÿßÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑŸÖÿ≥ÿßÿ±ÿßÿ™ ŸàÿßŸÑÿ£ÿ≥ŸÖÿßÿ°.');
    return;
  }

  const globalGraph = buildGraph(pathwaysData.features);
  addTransitions(globalGraph, transitionsData.features);

  const levels = [...new Set(detailsData.features.map(f=>f.properties.LEVEL_ID))];
  const floorsBar = document.getElementById('floors-bar');
  let currentLevel = levels[0];

  const nodesByLevel = {};
  levels.forEach(lvl=>{
    const lvlPW=pathwaysData.features.filter(f=>f.properties.LEVEL_ID===lvl);
    const g=buildGraph(lvlPW);
    nodesByLevel[lvl] = [...g.keys()].map(s=>s.split(',').map(Number));
  });

  const fromPanel = document.getElementById('fromRoomPanel');
  const toPanel   = document.getElementById('toRoomPanel');
  const searchBox = document.getElementById('search-box');
  const searchResults = document.getElementById('search-results');
  const routeInfo = document.getElementById('route-info');
  const directionsList = document.getElementById('directions-list');
  const rooms = [];

  function polygonCenter(coords){
    const ring=coords[0];
    let sx=0, sy=0;
    for(const p of ring){sx+=p[0]; sy+=p[1];}
    const n=ring.length || 1;
    return [sx/n, sy/n];
  }

  // Rooms ŸÖŸÜ Units ŸÖÿπ trim ŸÑŸÑÿ£ÿ≥ŸÖÿßÿ°
  unitsData.features.forEach((f,i)=>{
    const props=f.properties || {};
    let rawName = props.USE_TYPE || props.NAME || props.NAME_LONG || `Unit ${i}`;
    const name = String(rawName).trim();
    const lvl=props.LEVEL_ID;
    const geom=f.geometry;
    if(!geom || !lvl) return;
    let poly=null;
    if(geom.type==='Polygon') poly=geom.coordinates;
    else if(geom.type==='MultiPolygon') poly=geom.coordinates[0];
    if(!poly) return;
    const center=polygonCenter(poly);
    const room={id:i, name, level:lvl, center};
    rooms.push(room);
    const addOpt=(sel)=>{
      const o=document.createElement('option');
      o.value=i; o.text = `${name} (${lvl})`;
      sel.appendChild(o);
    };
    addOpt(fromPanel); addOpt(toPanel);
  });

  function markFloor(lvl){
    [...floorsBar.children].forEach(b=>{
      b.classList.toggle('floor-active', b.innerText===lvl);
    });
  }

  // *** UPDATED: ŸÜÿÆŸÑŸä ŸÉŸÑ ŸÑÿßŸäÿ±ÿßÿ™ ÿßŸÑÿ±ÿßŸàÿ™ ŸÅŸàŸÇ ÿ®ŸÖÿß ŸÅŸäŸáÿß ÿßŸÑŸÄ casing ÿßŸÑÿ¨ÿØŸäÿØ ***
  function bringRouteToFront(){
    ['route-3d-shadow','route-3d','route-casing','route'].forEach(id=>{
      if(map.getLayer(id)) map.moveLayer(id);
    });
  }

  function drawLevel(lvl){
    const sources = ['indoor-level','indoor-details','indoor-pathways','indoor-transitions','indoor-units'];
    const layers  = ['level-bg','walls','walls-flat','pathways','transitions','units','labels-rooms'];

    layers.forEach(id=>map.getLayer(id)&&map.removeLayer(id));
    sources.forEach(id=>map.getSource(id)&&map.removeSource(id));

    // Floor base
    const levelFeatures = levelsData.features.filter(f=>f.properties.LEVEL_ID===lvl);
    if(levelFeatures.length){
      map.addSource('indoor-level',{
        type:'geojson',
        data:{type:'FeatureCollection',features:levelFeatures}
      });
      map.addLayer({
        id:'level-bg',
        type:'fill',
        source:'indoor-level',
        paint:{
          'fill-color':'#FEFEFF',
          'fill-opacity':0.9
        }
      });
    }

    // WALLS
    const floorDetails = detailsData.features.filter(f=>f.properties.LEVEL_ID===lvl);
    const polys = floorDetails.map(f=>{
      if(f.geometry.type==='MultiLineString'){
        const c=f.geometry.coordinates[0];
        const closed=(c.length>2?[...c,c[0]]:c);
        f.geometry={type:'Polygon',coordinates:[closed]};
      }
      return f;
    });

    map.addSource('indoor-details',{'type':'geojson','data':{type:'FeatureCollection',features:polys}});

    map.addLayer({
      id: 'walls',
      type: 'fill-extrusion',
      source: 'indoor-details',
      filter: [
        'match',
        ['get','USE_TYPE'],
        ['A-Wall-INTR','A-Wall-EXTR','A-Glass-WALL','A-Window'],
        true,
        false
      ],
      paint: {
        'fill-extrusion-color': '#f3f4f6',
        'fill-extrusion-height': [
          'case',
          ['==',['get','USE_TYPE'],'A-Wall-EXTR'], 3.0,
          ['==',['get','USE_TYPE'],'A-Wall-INTR'], 2.8,
          ['==',['get','USE_TYPE'],'A-Glass-WALL'], 2.8,
          ['==',['get','USE_TYPE'],'A-Window'], 2.8,
          3.0
        ],
        'fill-extrusion-base': 0,
        'fill-extrusion-opacity': 1
      }
    });

    map.addLayer({
      id:'walls-flat',
      type:'fill',
      source:'indoor-details',
      filter:['!', ['match',['get','USE_TYPE'],true,false]],
      paint:{
        'fill-color':'#f9f8f4',
        'fill-opacity':0
      }
    });

    // PATHWAYS (ŸÑŸà ÿ≠ÿßÿ®ÿ® ÿ™ÿÆŸÑŸäŸáÿß ÿ∏ÿßŸáÿ±ÿ©ÿå ŸÖŸÖŸÉŸÜ ÿ™ÿ∂ŸäŸÅ layer ŸáŸÜÿß)
    const floorPw = pathwaysData.features.filter(f=>f.properties.LEVEL_ID===lvl);
    map.addSource('indoor-pathways',{
      type:'geojson',
      data:{type:'FeatureCollection',features:floorPw}
    });
    map.addLayer({
      id:'pathways',
      type:'line',
      source:'indoor-pathways',
      paint:{
        'line-color':'#b3c6ff',
        'line-width':1.5
      }
    });

    // TRANSITIONS
    const floorTr = transitionsData.features.filter(
      f=>f.properties.LEVEL_NAME_FROM===lvl || f.properties.LEVEL_NAME_TO===lvl
    );
    map.addSource('indoor-transitions',{
      type:'geojson',
      data:{type:'FeatureCollection',features:floorTr}
    });
    map.addLayer({
      id:'transitions',
      type:'circle',
      source:'indoor-transitions',
      paint:{
        'circle-radius':4,
        'circle-color':'#ff5722'
      }
    });

    // UNITS + labels
    const floorUnits = unitsData.features
      .filter(f=>f.properties.LEVEL_ID===lvl)
      .map(f=>{
        const clone = JSON.parse(JSON.stringify(f));
        if(clone.properties && typeof clone.properties.USE_TYPE === 'string'){
          clone.properties.USE_TYPE = clone.properties.USE_TYPE.trim();
        }
        return clone;
      });

    map.addSource('indoor-units',{
      type:'geojson',
      data:{type:'FeatureCollection',features:floorUnits}
    });

    map.addLayer({
      id:'units',
      type:'line',
      source:'indoor-units',
      paint:{
        'line-color':'#d0d4dd',
        'line-width':0.8
      }
    });

    map.addLayer({
      id:'labels-rooms',
      type:'symbol',
      source:'indoor-units',
      filter:[
        'all',
        ['!=',['get','USE_TYPE'],'A-Wall-INTR'],
        ['!=',['get','USE_TYPE'],'A-Wall-EXTR']
      ],
      layout:{
        'text-field':[
          'coalesce',
          ['get','USE_TYPE']
        ],
        'text-size':12,
        'text-offset':[0,0.4],
        'text-anchor':'top'
      },
      paint:{
        'text-color':'#333333',
        'text-halo-color':'#ffffff',
        'text-halo-width':1.5
      }
    });

    currentLevel=lvl;

    // ŸÑŸà ŸÅŸä ŸÖÿ≥ÿßÿ± ŸÖÿ™ÿÆÿ≤ŸëŸÜÿå ŸÜÿ±ÿ¨Ÿëÿπ ÿ™ŸÑŸàŸäŸÜŸá ÿ≠ÿ≥ÿ® ÿßŸÑÿØŸàÿ± ÿßŸÑÿ≠ÿßŸÑŸä
    if (lastRoutePath && lastRoutePath.length > 1 && map.getSource('route-3d')) {
      const currentFloorIndex = getFloorIndexFromLevelId(currentLevel);
      const extrusionData = buildRouteExtrusion(lastRoutePath, currentFloorIndex);
      map.getSource('route-3d').setData(extrusionData);
    }

    bringRouteToFront();
  }

  levels.forEach(lvl=>{
    const btn=document.createElement('div');
    btn.className='floor-btn';
    btn.innerText=lvl;
    btn.onclick=()=>{
      drawLevel(lvl);
      markFloor(lvl);
    };
    floorsBar.appendChild(btn);
  });

  markFloor(currentLevel);
  drawLevel(currentLevel);

  // ===== Route drawing / animation =====
  function startRouteMarkerAnimation(path) {
    if (animatedMarker) {
      animatedMarker.remove();
      animatedMarker = null;
    }
    if (animationFrameId) {
      cancelAnimationFrame(animationFrameId);
      animationFrameId = null;
    }

    animatedMarker = new maplibregl.Marker({color:'#2ecc71'})
      .setLngLat([path[0][0], path[0][1]])
      .addTo(map);

    const flatPath = path.map(p => [p[0], p[1]]);
    const segmentLengths = [];
    let totalLength = 0;
    for (let i=0; i<flatPath.length-1; i++) {
      const d = distance(flatPath[i], flatPath[i+1]);
      segmentLengths.push(d);
      totalLength += d;
    }

    let t = 0;

    function animate() {
      t += totalLength / 500;
      if (t > totalLength) t = 0;

      let distLeft = t;
      let idx = 0;
      while (idx < segmentLengths.length && distLeft > segmentLengths[idx]) {
        distLeft -= segmentLengths[idx];
        idx++;
      }

      if (idx >= segmentLengths.length) {
        animatedMarker.setLngLat(flatPath[flatPath.length-1]);
      } else {
        const p1 = flatPath[idx];
        const p2 = flatPath[idx+1];
        const r = segmentLengths[idx] === 0 ? 0 : distLeft / segmentLengths[idx];
        const lng = p1[0] + (p2[0]-p1[0])*r;
        const lat = p1[1] + (p2[1]-p1[1])*r;
        animatedMarker.setLngLat([lng,lat]);
      }

      animationFrameId = requestAnimationFrame(animate);
    }

    animationFrameId = requestAnimationFrame(animate);
  }

  // *** UPDATED: clearRoute Ÿäÿ¥ŸäŸÑ ŸÉŸÖÿßŸÜ route-casing + ŸäÿÆŸÑŸä lastRoutePath = null ***
  function clearRoute() {
    if(map.getLayer('route')) map.removeLayer('route');
    if(map.getLayer('route-casing')) map.removeLayer('route-casing');
    if(map.getSource('route-line')) map.removeSource('route-line');

    if(map.getLayer('route-3d')) map.removeLayer('route-3d');
    if(map.getLayer('route-3d-shadow')) map.removeLayer('route-3d-shadow');
    if(map.getSource('route-3d')) map.removeSource('route-3d');

    routeInfo.textContent='';
    directionsList.innerHTML='';

    if (animatedMarker) {
      animatedMarker.remove();
      animatedMarker = null;
    }
    if (animationFrameId) {
      cancelAnimationFrame(animationFrameId);
      animationFrameId = null;
    }

    lastRoutePath = null;
  }

  // *** UPDATED: drawRoute ÿ®ŸÜÿ≥ÿÆÿ© MazeMap (line + casing + 2D fill) + ÿßŸÑÿ£ŸÜŸäŸÖŸäÿ¥ŸÜ ÿßŸÑŸÇÿØŸäŸÖÿ© ***
  function drawRoute(path){
    clearRoute();

    // ÿÆÿ∑ ÿßŸÑŸÖÿ≥ÿßÿ± 2D
    const lineCoords = path.map(p => [p[0], p[1]]);

    map.addSource('route-line',{
      type:'geojson',
      data:{
        type:'FeatureCollection',
        features:[{
          type:'Feature',
          geometry:{type:'LineString',coordinates:lineCoords}
        }]
      }
    });

    // casing ŸÅÿßÿ™ÿ≠ ÿ™ÿ≠ÿ™
    map.addLayer({
      id: 'route-casing',
      type: 'line',
      source: 'route-line',
      paint: {
        'line-color': '#cde8ff',
        'line-width': 8,
        'line-opacity': 0.95,
        'line-cap': 'round',
        'line-join': 'round'
      }
    });

    // ÿÆÿ∑ ÿ£ÿ≤ÿ±ŸÇ ŸÅŸàŸÇŸá
    map.addLayer({
      id:'route',
      type:'line',
      source:'route-line',
      paint:{
        'line-color':'#007aff',
        'line-width':4.5,
        'line-opacity':1,
        'line-cap':'round',
        'line-join':'round'
      }
    });

    // ÿ®ŸÑÿßÿ∑ÿßÿ™ 2D ŸÅŸàŸÇ ÿßŸÑŸÖÿ≥ÿßÿ± ŸÑŸÑŸÄ floors
    const currentFloorIndex = getFloorIndexFromLevelId(currentLevel);
    const extrusionData = buildRouteExtrusion(path, currentFloorIndex);

    if (map.getSource('route-3d')) {
      map.getSource('route-3d').setData(extrusionData);
    } else {
      map.addSource('route-3d',{
        type:'geojson',
        data: extrusionData
      });
    }

    if (!map.getLayer('route-3d-shadow')) {
      map.addLayer({
        id:'route-3d-shadow',
        type:'fill',
        source:'route-3d',
        paint:{
          'fill-color':'rgba(0,0,0,0.12)',
          'fill-opacity':0.12
        }
      });
    }

    if (!map.getLayer('route-3d')) {
      map.addLayer({
        id:'route-3d',
        type:'fill',
        source:'route-3d',
        paint:{
          'fill-color':[
            'case',
            ['==',['get','isCurrentLevel'],true],
            '#1c8cff',
            '#b0b8c5'
          ],
          'fill-opacity':[
            'case',
            ['==',['get','isCurrentLevel'],true],
            0.9,
            0.4
          ]
        }
      });
    }

    bringRouteToFront();

    const bounds = new maplibregl.LngLatBounds();
    path.forEach(p=>bounds.extend([p[0],p[1]]));
    map.fitBounds(bounds,{padding:80,duration:1200});

    startRouteMarkerAnimation(path);
    lastRoutePath = path;
  }

  function updateRouteInfo(path){
    if(!path || path.length<2){
      routeInfo.textContent="";
      directionsList.innerHTML="";
      return;
    }
    let total=0;
    for(let i=0;i<path.length-1;i++){
      total+=distance(path[i],path[i+1]);
    }
    const floors = new Set(path.map(p => (p[2] ?? 0)));
    const metersTotal = total*111139;
    routeInfo.innerHTML =
      `Distance: <b>${metersTotal.toFixed(1)} m</b><br>` +
      `Floors passed: <b>${floors.size}</b>`;

    directionsList.innerHTML="";

    const toMeters = (a,b)=> distance(a,b)*111139;
    const bearing = (a,b)=> Math.atan2(b[1]-a[1], b[0]-a[0]);
    const angleDiffDeg = (b1,b2)=>{
      let d = (b2-b1)*180/Math.PI;
      while(d>180) d-=360;
      while(d<-180) d+=360;
      return d;
    };

    let stepIndex=1;
    let currentFloor=path[0][2] ?? 0;
    let prevBearing=null;

    for(let i=0;i<path.length-1;i++){
      const a = path[i];
      const b = path[i+1];
      const segLen = toMeters(a,b);
      const brg = bearing(a,b);
      let text="";

      if(i===0){
        text = `${stepIndex++}. Walk about ${segLen.toFixed(0)} m straight.`;
      } else {
        const diff = angleDiffDeg(prevBearing, brg);
        let turnWord = 'straight';
        if(Math.abs(diff) < 30){
          turnWord = 'straight';
        } else if(diff > 0){
          turnWord = 'left';
        } else {
          turnWord = 'right';
        }
        if(i === path.length-2){
          text = `${stepIndex++}. Turn ${turnWord} and walk ${segLen.toFixed(0)} m to reach your destination.`;
        } else {
          text = `${stepIndex++}. Turn ${turnWord} and walk about ${segLen.toFixed(0)} m.`;
        }
      }

      const div=document.createElement('div');
      div.className='direction-step';
      div.textContent=text;
      directionsList.appendChild(div);

      const nextFloor = (path[i+1][2] ?? currentFloor);
      if(nextFloor!==currentFloor){
        const fDiv=document.createElement('div');
        fDiv.className='direction-step';
        fDiv.textContent = `Floor change: go from level Z=${currentFloor} to Z=${nextFloor}.`;
        directionsList.appendChild(fDiv);
        currentFloor=nextFloor;
      }

      prevBearing = brg;
    }
  }

  function routeRooms(fromId, toId){
    const fr=rooms[fromId], to=rooms[toId];
    if(!fr || !to){
      alert('ÿßÿÆÿ™Ÿäÿßÿ± ÿ∫ÿ±ŸÅ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠');
      return;
    }

    if (fromId === toId) {
      drawLevel(fr.level);
      markFloor(fr.level);
      map.easeTo({ center: fr.center, zoom: 19 });
      clearRoute();
      return;
    }

    const sn=findNearestNode(fr.center, nodesByLevel[fr.level] || []);
    const en=findNearestNode(to.center, nodesByLevel[to.level] || []);
    if(!sn || !en){
      alert('ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿπŸÇÿØ ŸÇÿ±Ÿäÿ®ÿ© ŸÖŸÜ ÿßŸÑÿ∫ÿ±ŸÅ');
      return;
    }
    const s=sn.join(','), e=en.join(',');
    const path = dijkstra(globalGraph,s,e);
    if(path.length===0){
      alert('‚ùå ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖÿ≥ÿßÿ± ÿ®ŸäŸÜ ÿßŸÑÿ∫ÿ±ŸÅÿ™ŸäŸÜ');
      return;
    }
    drawRoute(path);
    updateRouteInfo(path);
  }

  document.getElementById('panelRouteBtn').onclick=()=>{
    const f=fromPanel.value, t=toPanel.value;
    if(!f || !t){
      alert('ÿßÿÆÿ™ÿ± ÿ∫ÿ±ŸÅÿ™Ÿä ÿßŸÑÿ®ÿØÿßŸäÿ© ŸàÿßŸÑŸÜŸáÿßŸäÿ©');
      return;
    }
    routeRooms(f,t);
  };

  document.getElementById('resetRouteBtn').onclick = clearRoute;
  document.getElementById('panelResetBtn').onclick = clearRoute;

  document.getElementById('zoomIn').onclick=()=>map.zoomTo(map.getZoom()+0.5);
  document.getElementById('zoomOut').onclick=()=>map.zoomTo(map.getZoom()-0.5);
  document.getElementById('tiltBtn').onclick=()=>{
    map.easeTo({pitch: map.getPitch()>10 ? 0 : 60});
  };

  // ========== Search ==========
  function selectRoomFromSearch(room){
    if(!fromPanel.value){
      fromPanel.value = room.id;
    } else if(!toPanel.value){
      toPanel.value = room.id;
    } else {
      fromPanel.value = room.id;
      toPanel.value = '';
    }
    drawLevel(room.level);
    markFloor(room.level);
    map.easeTo({center: room.center, zoom: 19});
  }

  searchBox.addEventListener('input', ()=>{
    const q = searchBox.value.trim().toLowerCase();
    if(q.length < 2){
      searchResults.style.display='none';
      searchResults.innerHTML='';
      return;
    }
    const matches = rooms
      .filter(r=>r.name.toLowerCase().includes(q))
      .slice(0,10);

    if(matches.length===0){
      searchResults.style.display='none';
      searchResults.innerHTML='';
      return;
    }

    searchResults.innerHTML='';
    matches.forEach(r=>{
      const div=document.createElement('div');
      div.className='search-item';
      div.textContent = `${r.name} (${r.level})`;
      div.onclick=()=>{
        selectRoomFromSearch(r);
        searchResults.style.display='none';
      };
      searchResults.appendChild(div);
    });
    searchResults.style.display='block';
  });

  document.addEventListener('click',(e)=>{
    if(!e.target.closest('#top-bar') && !e.target.closest('#search-results')){
      searchResults.style.display='none';
    }
  });

  // ========== Profile + Ads + Login ==========
  const studentNameInput = document.getElementById('student-name');
  const studentLevelSelect = document.getElementById('student-level');
  const studentGroupSelect = document.getElementById('student-group');
  const saveProfileBtn = document.getElementById('save-profile');
  const todayLectureTitle = document.getElementById('today-lecture-title');
  const todayLectureMeta = document.getElementById('today-lecture-meta');
  const goLectureBtn = document.getElementById('go-lecture-btn');
  const adsList = document.getElementById('ads-list');

  const loginOverlay = document.getElementById('login-overlay');
  const loginNameInput = document.getElementById('login-name');
  const loginLevelSelect = document.getElementById('login-level');
  const loginGroupSelect = document.getElementById('login-group');
  const loginSaveBtn = document.getElementById('login-save');

  function hideLoginOverlay(){ if(loginOverlay) loginOverlay.style.display='none'; }
  function showLoginOverlay(){ if(loginOverlay) loginOverlay.style.display='flex'; }

  if(rooms.length>0){
    const sortedForEntrance = [...rooms].sort((a,b)=> String(a.level).localeCompare(String(b.level)));
    entranceRoomId = sortedForEntrance[0].id;
  }

  function buildScheduleForProfile(profile){
    if(!profile || !profile.group) return [];
    const groupKey = profile.group in scheduleData ? profile.group : 'G1';
    const base = scheduleData[groupKey] || [];
    const schedule = [];
    base.forEach(entry=>{
      const hallCode = entry.hall;
      const room = rooms.find(r=>{
        const normalized = r.name.replace(/\s+/g,'').toUpperCase();
        return normalized === hallCode.toUpperCase();
      });
      if(!room) return;
      schedule.push({
        title: entry.subject + ' ['+groupKey+']',
        time: entry.time,
        dayCode: entry.day,
        dayLabel: dayLabels[entry.day] || entry.day,
        roomIndex: room.id,
        roomName: room.name,
        level: room.level
      });
    });
    return schedule;
  }

  function applyLectureToUI(){
    if(!firstLecture){
      todayLectureTitle.textContent = 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ≠ÿßÿ∂ÿ±ÿ© ŸÖÿ¨ÿØŸàŸÑÿ© ÿßŸÑÿ¢ŸÜ (ÿØŸäŸÖŸà)';
      todayLectureMeta.textContent = '';
      goLectureBtn.disabled = true;
      return;
    }
    todayLectureTitle.textContent = 'Next: ' + firstLecture.title;
    todayLectureMeta.textContent =
      `${firstLecture.dayLabel} ‚Ä¢ ${firstLecture.time} ‚Ä¢ ${firstLecture.roomName} (${firstLecture.level})`;
    goLectureBtn.disabled = false;
  }

  function routeToFirstLecture(){
    if(!firstLecture) return;
    const fromId = (entranceRoomId != null) ? entranceRoomId : firstLecture.roomIndex;
    const toId = firstLecture.roomIndex;
    fromPanel.value = fromId;
    toPanel.value = toId;
    routeRooms(fromId,toId);
  }

  function setupScheduleAndLecture(){
    if(!studentProfile || !studentProfile.group){
      firstLecture = null;
      applyLectureToUI();
      return;
    }
    currentSchedule = buildScheduleForProfile(studentProfile);
    if(currentSchedule.length === 0){
      firstLecture = null;
      applyLectureToUI();
      return;
    }
    const dayCodes = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    const todayCode = dayCodes[new Date().getDay()];
    const todayLectures = currentSchedule.filter(l=>l.dayCode === todayCode);
    firstLecture = todayLectures[0] || currentSchedule[0];
    applyLectureToUI();
  }

  if(saveProfileBtn){
    saveProfileBtn.onclick = ()=>{
      const name = (studentNameInput.value || '').trim() || 'Student';
      const levelVal = studentLevelSelect.value;
      const groupVal = studentGroupSelect.value || 'G1';
      if(!levelVal){
        alert('ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿØÿ±ÿßÿ≥Ÿä');
        return;
      }
      studentProfile = {name, level: levelVal, group: groupVal};
      try{ localStorage.setItem('cuProfile', JSON.stringify(studentProfile)); }catch(e){}
      if(loginNameInput) loginNameInput.value = name;
      if(loginLevelSelect) loginLevelSelect.value = levelVal;
      if(loginGroupSelect) loginGroupSelect.value = groupVal;
      setupScheduleAndLecture();
      hideLoginOverlay();
    };
  }

  if(loginSaveBtn){
    loginSaveBtn.onclick = ()=>{
      const name = (loginNameInput.value || '').trim() || 'Student';
      const levelVal = loginLevelSelect.value;
      const groupVal = loginGroupSelect.value || 'G1';
      if(!levelVal){
        alert('ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿØÿ±ÿßÿ≥Ÿä');
        return;
      }
      studentProfile = {name, level: levelVal, group: groupVal};
      try{ localStorage.setItem('cuProfile', JSON.stringify(studentProfile)); }catch(e){}
      if(studentNameInput) studentNameInput.value = name;
      if(studentLevelSelect) studentLevelSelect.value = levelVal;
      if(studentGroupSelect && groupVal) studentGroupSelect.value = groupVal;
      setupScheduleAndLecture();
      hideLoginOverlay();
      routeToFirstLecture();
    };
  }

  if(goLectureBtn){ goLectureBtn.onclick = routeToFirstLecture; }

  function loadProfileFromStorage(){
    try{
      const raw = localStorage.getItem('cuProfile');
      if(!raw) { showLoginOverlay(); return; }
      const prof = JSON.parse(raw);
      if(!prof || !prof.level) { showLoginOverlay(); return; }
      studentProfile = prof;
      if(studentNameInput) studentNameInput.value = prof.name || '';
      if(studentLevelSelect) studentLevelSelect.value = prof.level;
      if(studentGroupSelect && prof.group) studentGroupSelect.value = prof.group;
      if(loginNameInput) loginNameInput.value = prof.name || '';
      if(loginLevelSelect) loginLevelSelect.value = prof.level;
      if(loginGroupSelect && prof.group) loginGroupSelect.value = prof.group;
      setupScheduleAndLecture();
      hideLoginOverlay();
    }catch(e){ showLoginOverlay(); }
  }

  function setupAds(){
    if(!adsList) return;
    adsData = [];
    if(rooms.length === 0) return;

    const spot1 = rooms.find(r=>/CAF|CAFE|FOOD/i.test(r.name)) || rooms[0];
    const spot2 = rooms.find(r=>/LAB/i.test(r.name)) || rooms[1] || rooms[0];
    const spot3 = rooms[2] || rooms[0];

    if(spot1) adsData.push({
      id:'ad1',
      title:'EGFood ‚Ä¢ Campus Lunch',
      text:'ÿÆÿµŸÖ ÿÆÿßÿµ ŸÑÿ∑ŸÑÿ®ÿ© ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿ±ÿßÿ®ÿπ ÿ®ÿßŸÑŸÇÿ±ÿ® ŸÖŸÜ ' + spot1.name,
      roomIndex: spot1.id
    });
    if(spot2) adsData.push({
      id:'ad2',
      title:'New Lab Opening',
      text:'ŸÖÿπŸÖŸÑ ÿ¨ÿØŸäÿØ ÿ¨ÿßŸáÿ≤ ŸÑŸÑÿ™ÿ¨ÿßÿ±ÿ® ÿ®ÿ¨Ÿàÿßÿ± ' + spot2.name,
      roomIndex: spot2.id
    });
    if(spot3) adsData.push({
      id:'ad3',
      title:'Student Event',
      text:'Event ÿ∑ŸÑÿßÿ®Ÿä ŸÇÿ±Ÿäÿ® ŸÖŸÜ ' + spot3.name,
      roomIndex: spot3.id
    });

    adsList.innerHTML = '';
    adsData.forEach(ad=>{
      const card = document.createElement('div');
      card.className = 'ad-card';
      card.innerHTML =
        '<div class="ad-title">'+ad.title+'</div>' +
        '<div class="ad-text">'+ad.text+'</div>' +
        '<div class="ad-badge">Sponsored</div>';
      card.onclick = ()=>focusAd(ad);
      adsList.appendChild(card);
    });
  }

  function focusAd(ad){
    const room = rooms.find(r=>r.id === ad.roomIndex);
    if(!room) return;
    drawLevel(room.level);
    markFloor(room.level);
    map.easeTo({center: room.center, zoom: 19, duration: 1200});
  }

  // ===== AI CHAT HOOKUP =====
  const aiMessages = document.getElementById('ai-messages');
  const aiInput    = document.getElementById('ai-input');
  const aiSendBtn  = document.getElementById('ai-send-btn');
  const aiPanel    = document.getElementById('ai-panel');
  const aiToggleBtn= document.getElementById('ai-toggle-btn');

  let aiPanelOpen = false;
  let highlightedUnitId = null;

  function openAiPanel(){
    if(aiPanel){
      aiPanel.style.display = 'flex';
      aiPanelOpen = true;
    }
  }
  function closeAiPanel(){
    if(aiPanel){
      aiPanel.style.display = 'none';
      aiPanelOpen = false;
    }
  }

  if(aiToggleBtn){
    aiToggleBtn.onclick = ()=>{
      if(aiPanelOpen) closeAiPanel();
      else openAiPanel();
    };
  }

  function appendAiMessage(sender, text){
    if(!aiMessages) return;
    const div = document.createElement('div');
    div.className = 'ai-msg ' + (sender === 'user' ? 'ai-msg-user' : 'ai-msg-ai');
    div.textContent = text;
    aiMessages.appendChild(div);
    aiMessages.scrollTop = aiMessages.scrollHeight;
  }

  // ===== SMART AI COMMAND PARSER =====
  
  // ÿ™ÿµÿ≠Ÿäÿ≠ ÿßŸÑÿ£ÿÆÿ∑ÿßÿ° ÿßŸÑÿ•ŸÖŸÑÿßÿ¶Ÿäÿ© ÿßŸÑÿ¥ÿßÿ¶ÿπÿ©
  function normalizeText(text) {
    return text
      .replace(/ŸÖÿØÿ±ÿßÿ¨/g, 'ŸÖÿØÿ±ÿ¨')
      .replace(/ŸÖÿØÿßÿ±ÿ¨/g, 'ŸÖÿØÿ±ÿ¨')
      .replace(/ŸÇÿßÿπÿ©/g, 'ŸÖÿØÿ±ÿ¨')
      .replace(/ŸÇÿßÿπŸá/g, 'ŸÖÿØÿ±ÿ¨')
      .replace(/ÿ∫ÿ±ŸÅÿ©/g, 'ŸÖÿØÿ±ÿ¨')
      .replace(/ÿ∫ÿ±ŸÅŸá/g, 'ŸÖÿØÿ±ÿ¨')
      .replace(/ÿßŸàÿØŸäÿ™Ÿàÿ±ŸäŸàŸÖ/g, 'ŸÖÿØÿ±ÿ¨')
      .replace(/ÿßŸÑŸâ/g, 'ÿ•ŸÑŸâ')
      .replace(/ÿßŸÑŸä/g, 'ÿ•ŸÑŸâ')
      .replace(/ŸÑ\s/g, 'ÿ•ŸÑŸâ ')
      .replace(/ŸÑŸÄ/g, 'ÿ•ŸÑŸâ ')
      .replace(/ÿ¨ÿ±Ÿàÿ®/g, 'group')
      .replace(/ŸÖÿ¨ŸÖŸàÿπÿ©/g, 'group')
      .replace(/ÿßŸÑŸÖÿ¨ŸÖŸàÿπÿ©/g, 'group')
      .replace(/ÿßŸÑÿ¨ÿ±Ÿàÿ®/g, 'group')
      .replace(/ÿ∫Ÿäÿ±/g, 'change')
      .replace(/ÿ®ÿØŸÑ/g, 'change')
      .replace(/ÿ≠ŸàŸÑ/g, 'change');
  }

  // ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿ±ŸÇŸÖ ÿßŸÑŸÖÿØÿ±ÿ¨ ŸÖŸÜ ÿßŸÑŸÜÿµ
  function extractHallNumber(text) {
    // ÿ£ŸÜŸÖÿßÿ∑ ŸÖÿÆÿ™ŸÑŸÅÿ© ŸÑŸÑŸÖÿØÿ±ÿ¨
    const patterns = [
      /ŸÖÿØÿ±ÿ¨\s*(\d+)/gi,
      /hall\s*(\d+)/gi,
      /room\s*(\d+)/gi,
      /(\d{3})/g  // ÿ£Ÿä ÿ±ŸÇŸÖ ŸÖŸÜ 3 ÿ£ÿ±ŸÇÿßŸÖ
    ];
    
    const numbers = [];
    for (const pattern of patterns) {
      let match;
      while ((match = pattern.exec(text)) !== null) {
        numbers.push(match[1]);
      }
    }
    return [...new Set(numbers)]; // ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑŸÖŸÉÿ±ÿ±
  }

  // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿ∫ÿ±ŸÅÿ© ÿ®ÿßŸÑÿ±ŸÇŸÖ
  function findRoomByNumber(number) {
    const hallCode = 'HALL' + number;
    return rooms.find(r => {
      const normalized = r.name.replace(/\s+/g, '').toUpperCase();
      return normalized === hallCode || 
             normalized.includes(hallCode) ||
             normalized === number ||
             r.name.includes(number);
    });
  }

  // ÿ™ÿ≠ÿØŸäÿØ ÿ∫ÿ±ŸÅÿ© ÿ®ÿßŸÑŸÑŸàŸÜ ÿßŸÑÿ£ÿ≠ŸÖÿ±
  function highlightRoom(room) {
    if (!room) return;
    
    highlightedUnitId = room.name;
    
    // ÿßŸÑÿßŸÜÿ™ŸÇÿßŸÑ ŸÑŸÑÿØŸàÿ± ÿßŸÑÿµÿ≠Ÿäÿ≠
    drawLevel(room.level);
    markFloor(room.level);
    
    // ÿ•ÿ∂ÿßŸÅÿ© ÿ∑ÿ®ŸÇÿ© ÿßŸÑÿ™ÿ≠ÿØŸäÿØ ÿßŸÑÿ£ÿ≠ŸÖÿ±
    setTimeout(() => {
      if (map.getLayer('units-highlight')) map.removeLayer('units-highlight');
      if (map.getSource('units-highlight')) map.removeSource('units-highlight');
      
      const highlightFeatures = unitsData.features.filter(f => {
        const props = f.properties || {};
        const name = (props.USE_TYPE || props.NAME || '').trim();
        return name === highlightedUnitId && f.properties.LEVEL_ID === room.level;
      });
      
      if (highlightFeatures.length > 0) {
        map.addSource('units-highlight', {
          type: 'geojson',
          data: { type: 'FeatureCollection', features: highlightFeatures }
        });
        
        map.addLayer({
          id: 'units-highlight',
          type: 'fill',
          source: 'units-highlight',
          paint: {
            'fill-color': '#ff0000',
            'fill-opacity': 0.6
          }
        });
      }
      
      // ÿßŸÑÿ™ÿ±ŸÉŸäÿ≤ ÿπŸÑŸâ ÿßŸÑÿ∫ÿ±ŸÅÿ©
      map.easeTo({ center: room.center, zoom: 19, duration: 1000 });
    }, 100);
  }

  // ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ™ÿ≠ÿØŸäÿØ
  function clearHighlight() {
    highlightedUnitId = null;
    if (map.getLayer('units-highlight')) map.removeLayer('units-highlight');
    if (map.getSource('units-highlight')) map.removeSource('units-highlight');
  }

  // ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿ¨ÿ±Ÿàÿ®
  function changeGroup(groupNum) {
    const groupKey = 'G' + groupNum;
    if (!scheduleData[groupKey]) {
      return { success: false, message: `ÿßŸÑÿ¨ÿ±Ÿàÿ® ${groupKey} ŸÖÿ¥ ŸÖŸàÿ¨ŸàÿØ` };
    }
    
    studentProfile = studentProfile || { name: 'Student', level: 'Level1' };
    studentProfile.group = groupKey;
    
    // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÄ UI
    if (studentGroupSelect) studentGroupSelect.value = groupKey;
    if (loginGroupSelect) loginGroupSelect.value = groupKey;
    
    // ÿ≠ŸÅÿ∏ ŸÅŸä localStorage
    try { localStorage.setItem('cuProfile', JSON.stringify(studentProfile)); } catch(e) {}
    
    // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ¨ÿØŸàŸÑ
    setupScheduleAndLecture();
    
    return { success: true, message: `ÿ™ŸÖ ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿ¨ÿ±Ÿàÿ® ÿ•ŸÑŸâ ${groupKey} ‚úÖ` };
  }

  // ŸÖÿπÿßŸÑÿ¨ÿ© ÿ£ŸàÿßŸÖÿ± AI
  function processAiCommand(message) {
    const normalized = normalizeText(message);
    const lowerMsg = normalized.toLowerCase();
    
    // 1. ÿ£ŸÖÿ± ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿ¨ÿ±Ÿàÿ®
    const groupMatch = lowerMsg.match(/(?:change|ÿ∫Ÿäÿ±)\s*(?:group|ÿßŸÑÿ¨ÿ±Ÿàÿ®)?\s*(?:ÿ•ŸÑŸâ|ŸÑ)?\s*(?:g)?(\d)/i) ||
                       lowerMsg.match(/group\s*(\d)/i) ||
                       lowerMsg.match(/g(\d)/i);
    
    if (groupMatch || lowerMsg.includes('change') && lowerMsg.match(/\d/)) {
      const num = groupMatch ? groupMatch[1] : lowerMsg.match(/(\d)/)[1];
      const result = changeGroup(num);
      return { handled: true, response: result.message };
    }
    
    // 2. ÿ£ŸÖÿ± ÿßŸÑÿ™ŸÜŸÇŸÑ ŸÖŸÜ ÿ∫ÿ±ŸÅÿ© ÿ•ŸÑŸâ ÿ∫ÿ±ŸÅÿ©
    const navigationMatch = normalized.match(/(?:ŸàÿØŸäŸÜŸä|ÿÆÿØŸÜŸä|ÿ±Ÿàÿ≠|ŸÖŸÜ)\s+(?:ŸÖŸÜ\s+)?(?:ŸÖÿØÿ±ÿ¨\s*)?(\d+)\s+(?:ÿ•ŸÑŸâ|ŸÑ)\s+(?:ŸÖÿØÿ±ÿ¨\s*)?(\d+)/i) ||
                           normalized.match(/ŸÖŸÜ\s+(?:ŸÖÿØÿ±ÿ¨\s*)?(\d+)\s+(?:ÿ•ŸÑŸâ|ŸÑ)\s+(?:ŸÖÿØÿ±ÿ¨\s*)?(\d+)/i);
    
    if (navigationMatch) {
      const fromNum = navigationMatch[1];
      const toNum = navigationMatch[2];
      const fromRoom = findRoomByNumber(fromNum);
      const toRoom = findRoomByNumber(toNum);
      
      if (!fromRoom) {
        return { handled: true, response: `ŸÖÿ¥ ŸÑÿßŸÇŸä ŸÖÿØÿ±ÿ¨ ${fromNum} üòï` };
      }
      if (!toRoom) {
        return { handled: true, response: `ŸÖÿ¥ ŸÑÿßŸÇŸä ŸÖÿØÿ±ÿ¨ ${toNum} üòï` };
      }
      
      // ÿ™ŸÜŸÅŸäÿ∞ ÿßŸÑÿ™ŸÜŸÇŸÑ
      clearHighlight();
      fromPanel.value = fromRoom.id;
      toPanel.value = toRoom.id;
      routeRooms(fromRoom.id, toRoom.id);
      
      return { 
        handled: true, 
        response: `ÿ¨ÿßÿ±Ÿä ÿ±ÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿßÿ± ŸÖŸÜ ŸÖÿØÿ±ÿ¨ ${fromNum} ÿ•ŸÑŸâ ŸÖÿØÿ±ÿ¨ ${toNum} üó∫Ô∏è` 
      };
    }
    
    // 3. ÿ£ŸÖÿ± ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿ∫ÿ±ŸÅÿ© Ÿàÿßÿ≠ÿØÿ© (ŸÅŸäŸÜ ŸÖÿØÿ±ÿ¨ X)
    const halls = extractHallNumber(normalized);
    if (halls.length === 1) {
      const room = findRoomByNumber(halls[0]);
      if (room) {
        highlightRoom(room);
        return { 
          handled: true, 
          response: `ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ŸÖÿØÿ±ÿ¨ ${halls[0]} ÿ®ÿßŸÑŸÑŸàŸÜ ÿßŸÑÿ£ÿ≠ŸÖÿ± ŸÅŸä ÿßŸÑÿØŸàÿ± ${room.level} üìç` 
        };
      } else {
        return { handled: true, response: `ŸÖÿ¥ ŸÑÿßŸÇŸä ŸÖÿØÿ±ÿ¨ ${halls[0]} üòï` };
      }
    }
    
    // 4. ÿ£ŸÖÿ± ÿπÿ±ÿ∂ ÿßŸÑÿ¨ÿØŸàŸÑ
    if (lowerMsg.includes('ÿ¨ÿØŸàŸÑ') || lowerMsg.includes('ŸÖÿ≠ÿßÿ∂ÿ±') || lowerMsg.includes('schedule')) {
      if (!currentSchedule || currentSchedule.length === 0) {
        return { handled: true, response: 'ŸÖŸÅŸäÿ¥ ÿ¨ÿØŸàŸÑ ŸÖÿ≠ŸÅŸàÿ∏. ÿßÿÆÿ™ÿßÿ± ÿßŸÑÿ¨ÿ±Ÿàÿ® ÿßŸÑÿ£ŸàŸÑ.' };
      }
      
      let scheduleText = 'ÿ¨ÿØŸàŸÑŸÉ:\n';
      currentSchedule.forEach((lec, i) => {
        scheduleText += `${i+1}. ${lec.title} - ${lec.dayLabel} ${lec.time} (${lec.roomName})\n`;
      });
      return { handled: true, response: scheduleText };
    }
    
    // 5. ÿ£ŸÖÿ± ÿßŸÑŸÖÿ≥ÿßÿπÿØÿ©
    if (lowerMsg.includes('ŸÖÿ≥ÿßÿπÿØ') || lowerMsg.includes('help') || lowerMsg.includes('ÿßÿ≤ÿßŸä')) {
      return { 
        handled: true, 
        response: `ŸÖŸÖŸÉŸÜ ÿ™ŸÇŸàŸÑŸä:
‚Ä¢ "ŸÅŸäŸÜ ŸÖÿØÿ±ÿ¨ 161" - Ÿáÿ≠ÿØÿØŸá ÿ®ÿßŸÑÿ£ÿ≠ŸÖÿ±
‚Ä¢ "ŸàÿØŸäŸÜŸä ŸÖŸÜ ŸÖÿØÿ±ÿ¨ 161 ÿ•ŸÑŸâ 262" - Ÿáÿ±ÿ≥ŸÖŸÑŸÉ ÿßŸÑŸÖÿ≥ÿßÿ±
‚Ä¢ "ÿ∫Ÿäÿ± ÿßŸÑÿ¨ÿ±Ÿàÿ® ŸÑŸÄ G2" - Ÿáÿ∫Ÿäÿ±ŸÑŸÉ ÿßŸÑÿ¨ÿ±Ÿàÿ®
‚Ä¢ "ÿ¨ÿØŸàŸÑŸä" - Ÿáÿπÿ±ÿ∂ŸÑŸÉ ŸÖÿ≠ÿßÿ∂ÿ±ÿßÿ™ŸÉ` 
      };
    }
    
    // 6. ÿ£ŸÖÿ± ŸÖÿ≥ÿ≠ ÿßŸÑÿ™ÿ≠ÿØŸäÿØ
    if (lowerMsg.includes('ÿßŸÖÿ≥ÿ≠') || lowerMsg.includes('clear') || lowerMsg.includes('reset')) {
      clearHighlight();
      clearRoute();
      return { handled: true, response: 'ÿ™ŸÖ ŸÖÿ≥ÿ≠ ŸÉŸÑ ÿ¥Ÿäÿ° ‚ú®' };
    }
    
    // ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿ™ÿπÿ±ŸÅ ÿπŸÑŸâ ÿßŸÑÿ£ŸÖÿ±
    return { handled: false };
  }

  async function sendAiMessage(){
    const msg = (aiInput.value || '').trim();
    if(!msg) return;
    appendAiMessage('user', msg);
    aiInput.value = '';

    // ŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ£ŸÖÿ± ŸÖÿ≠ŸÑŸäÿßŸã ÿ£ŸàŸÑÿßŸã
    const result = processAiCommand(msg);
    
    if (result.handled) {
      appendAiMessage('ai', result.response);
      return;
    }

    // ŸÑŸà ŸÖÿ¥ ÿ£ŸÖÿ± ŸÖÿπÿ±ŸàŸÅÿå ŸÜÿ±ÿ≥ŸÑ ŸÑŸÑŸÄ API
    try{
      const res = await fetch('http://localhost:3000/api/chat', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({
          message: msg,
          profile: studentProfile,
          schedule: currentSchedule
        })
      });

      if(!res.ok){
        appendAiMessage('ai', '‚ùå ÿ≠ÿµŸÑ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±.');
        return;
      }

      const data = await res.json();
      appendAiMessage('ai', data.reply || 'ŸÖÿßŸÇÿØÿ±ÿ™ÿ¥ ÿ£ÿ∑ŸÑÿπ ÿ±ÿØ Ÿäÿß ŸÜÿ¨ŸÖ.');
    } catch(err){
      console.error('AI error:', err);
      // ŸÑŸà ŸÖŸÅŸäÿ¥ ÿ≥Ÿäÿ±ŸÅÿ±ÿå ŸÜÿ±ÿØ ÿ±ÿØ ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä
      appendAiMessage('ai', 'ŸÖÿ¥ ŸÅÿßŸáŸÖ ŸÇÿµÿØŸÉ ü§î ÿ¨ÿ±ÿ® ÿ™ŸÇŸàŸÑ "ŸÖÿ≥ÿßÿπÿØÿ©" ÿπÿ¥ÿßŸÜ ÿ£ŸÇŸàŸÑŸÉ ÿ£ŸÇÿØÿ± ÿ£ÿπŸÖŸÑŸÉ ÿ•ŸäŸá.');
    }
  }

  if(aiSendBtn && aiInput){
    aiSendBtn.onclick = sendAiMessage;
    aiInput.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter') sendAiMessage();
    });
  }

  appendAiMessage('ai', 'ÿ£ŸáŸÑÿß ÿ®ŸäŸÉ üëã ŸÇŸàŸÑŸä "ŸàÿØŸäŸÜŸä ŸÖŸÜ ŸÖÿØÿ±ÿ¨ 161 ÿ•ŸÑŸâ 262" ÿ£Ÿà "ŸÅŸäŸÜ ŸÖÿØÿ±ÿ¨ 559" ÿ£Ÿà "ÿ∫Ÿäÿ± ÿßŸÑÿ¨ÿ±Ÿàÿ® ŸÑŸÄ G2"');

  // ===== User panel toggle =====
  const userPanel = document.getElementById('user-panel');
  const userHeader = document.getElementById('user-panel-header');
  const userTitleText = document.getElementById('user-title-text');
  const userPanelBody = document.getElementById('user-panel-body');
  let userPanelCollapsed = false;

  if(userHeader){
    userHeader.onclick = ()=>{
      userPanelCollapsed = !userPanelCollapsed;
      if(userPanelCollapsed){
        userPanel.classList.add('collapsed');
        if(userPanelBody) userPanelBody.style.display = 'none';
        if(userTitleText) userTitleText.textContent = 'MY DAYS';
      }else{
        userPanel.classList.remove('collapsed');
        if(userPanelBody) userPanelBody.style.display = 'block';
        if(userTitleText) userTitleText.textContent = 'My Day';
      }
    };
  }

  // init
  loadProfileFromStorage();
  setupAds();

  // ===== MOBILE TOGGLE FUNCTIONALITY =====
  const navToggleBtn = document.getElementById('nav-toggle-btn');
  const maydayToggleBtn = document.getElementById('mayday-toggle-btn');
  const mobileOverlay = document.getElementById('mobile-overlay');
  const sidePanel = document.getElementById('side-panel');

  function isMobile() {
    return window.innerWidth <= 768;
  }

  function closeAllMobilePanels() {
    if(sidePanel) sidePanel.classList.remove('mobile-open');
    if(userPanel) userPanel.classList.remove('mobile-open');
    if(mobileOverlay) mobileOverlay.classList.remove('active');
  }

  // Navigation toggle
  if(navToggleBtn && sidePanel) {
    navToggleBtn.onclick = () => {
      if(!isMobile()) return;
      
      const isOpen = sidePanel.classList.contains('mobile-open');
      closeAllMobilePanels();
      
      if(!isOpen) {
        sidePanel.classList.add('mobile-open');
        mobileOverlay.classList.add('active');
      }
    };
  }

  // Maydays toggle (uses user-panel as Maydays/Schedule panel)
  if(maydayToggleBtn && userPanel) {
    maydayToggleBtn.onclick = () => {
      if(!isMobile()) return;
      
      const isOpen = userPanel.classList.contains('mobile-open');
      closeAllMobilePanels();
      
      if(!isOpen) {
        userPanel.classList.add('mobile-open');
        mobileOverlay.classList.add('active');
      }
    };
  }

  // Close panels when clicking overlay
  if(mobileOverlay) {
    mobileOverlay.onclick = closeAllMobilePanels;
  }

  // Close panels after route is found on mobile
  const originalPanelRouteBtn = document.getElementById('panelRouteBtn');
  if(originalPanelRouteBtn) {
    const originalOnClick = originalPanelRouteBtn.onclick;
    originalPanelRouteBtn.onclick = () => {
      if(originalOnClick) originalOnClick();
      if(isMobile()) {
        setTimeout(closeAllMobilePanels, 300);
      }
    };
  }

});
</script>

</body>
</html>